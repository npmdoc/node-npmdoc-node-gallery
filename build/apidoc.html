<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="http://www.github.com/cianclarke/node-gallery"

    >node-gallery (v1.1.0)</a>
</h1>
<h4>NodeJS Photo Gallery using directory structure & exif info to output a gallery</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-gallery">module node-gallery</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.node-gallery">
            function <span class="apidocSignatureSpan"></span>node-gallery
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.album">
            function <span class="apidocSignatureSpan">node-gallery.</span>album
            <span class="apidocSignatureSpan">(cfg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.common">
            function <span class="apidocSignatureSpan">node-gallery.</span>common
            <span class="apidocSignatureSpan">(cfg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.exif">
            function <span class="apidocSignatureSpan">node-gallery.</span>exif
            <span class="apidocSignatureSpan">(staticPath, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.middleware">
            function <span class="apidocSignatureSpan">node-gallery.</span>middleware
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.photo">
            function <span class="apidocSignatureSpan">node-gallery.</span>photo
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.toString">
            function <span class="apidocSignatureSpan">node-gallery.</span>toString
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-gallery.album">module node-gallery.album</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.album.album">
            function <span class="apidocSignatureSpan">node-gallery.</span>album
            <span class="apidocSignatureSpan">(cfg)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-gallery.common">module node-gallery.common</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.common.common">
            function <span class="apidocSignatureSpan">node-gallery.</span>common
            <span class="apidocSignatureSpan">(cfg)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-gallery.exif">module node-gallery.exif</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.exif.exif">
            function <span class="apidocSignatureSpan">node-gallery.</span>exif
            <span class="apidocSignatureSpan">(staticPath, callback)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-gallery.middleware">module node-gallery.middleware</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.middleware.middleware">
            function <span class="apidocSignatureSpan">node-gallery.</span>middleware
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-gallery.photo">module node-gallery.photo</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.photo.photo">
            function <span class="apidocSignatureSpan">node-gallery.</span>photo
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-gallery.toString">module node-gallery.toString</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-gallery.toString.toString">
            function <span class="apidocSignatureSpan">node-gallery.</span>toString
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-gallery" id="apidoc.module.node-gallery">module node-gallery</a></h1>


    <h2>
        <a href="#apidoc.element.node-gallery.node-gallery" id="apidoc.element.node-gallery.node-gallery">
        function <span class="apidocSignatureSpan"></span>node-gallery
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">node-gallery = function (config){
  if (!config){
    throw new Error(&#x27;No config specified&#x27;);
  }

  if (!config.staticFiles || !config.urlRoot){
    throw new Error(&#x27;Both staticFiles and urlRoot must be specified&#x27;);
  }

  var common = require(&#x27;./common&#x27;)(config),
  middleware;

  // Remove any potential trailing or leading / from our paths
  config.staticFiles = common.friendlyPath(config.staticFiles);
  config.urlRoot = common.friendlyPath(config.urlRoot);

  middleware = require(&#x27;./middleware&#x27;)(config);

  return middleware;

}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-gallery.album" id="apidoc.element.node-gallery.album">
        function <span class="apidocSignatureSpan">node-gallery.</span>album
        <span class="apidocSignatureSpan">(cfg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">album = function (cfg){
  config = cfg;
  common = require(&#x27;./common&#x27;)(config);
  return function(req, res, next){

    // Retrieve the path, decoding %20s etc, replacing leading &#x26; trailing slash
    var pathFromReq = common.friendlyPath(req.path),
    staticFilesPath = &#x27;./&#x27; + path.join(config.staticFiles, pathFromReq),
    data = _.clone(config);

<span class="apidocCodeCommentSpan">    /*
     Request for an album thumbnail - TODO consider splitting out
     */
</span>    if (req.query &#x26;&#x26; req.query.tn){
      return _thumbnail(staticFilesPath, pathFromReq, function(err, thumb){
        if (err){
          return common.error(req, res, next, 404, &#x27;No thumbnail found for this album&#x27;, err);
        }
        var fstream = fs.createReadStream(path.join(thumb));
        fstream.on(&#x27;error&#x27;, function(err){
          return common.error(req, res, next, 404, &#x27;No thumbnail found for this album&#x27;, err);
        });
        return fstream.pipe(res);
      });
    }
    /*
      Determined we&#x27;re not requesting the thumbnail file - render the album page
     */
    fs.readdir(staticFilesPath, function (err, files) {
      if (err){
        return common.error(req, res, next, 404, &#x27;No album found&#x27;, err);
      }

      data.isRoot = (req.path === &#x27;/&#x27; || req.path === &#x27;&#x27;);
      data.breadcrumb = common.breadcrumb(pathFromReq),
      data.name = _.last(data.breadcrumb).name || config.title;

      data.albums = _getAlbums(files, staticFilesPath, pathFromReq);
      data.photos = _getPhotos(files, staticFilesPath, pathFromReq);

      req.data = data;
      req.tpl = &#x27;album.ejs&#x27;;
      return next();
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-gallery.common" id="apidoc.element.node-gallery.common">
        function <span class="apidocSignatureSpan">node-gallery.</span>common
        <span class="apidocSignatureSpan">(cfg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">common = function (cfg){
  config = cfg;
  return common;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-gallery.exif" id="apidoc.element.node-gallery.exif">
        function <span class="apidocSignatureSpan">node-gallery.</span>exif
        <span class="apidocSignatureSpan">(staticPath, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">exif = function (staticPath, callback){
  try {
    new ExifImage({
      image : staticPath//&#x27;resources/photos/Ireland/West Coast/_MG_4174.jpg&#x27;
    }, function (error, data) {

      if (error){
        return callback(error);
      }else{
        var exifMap = {};
        var image = data.image,
        exif = data.exif,
        gps = data.gps,
        arrays = image.concat(exif, gps);

        for (var i=0; i&#x3c;arrays.length; i++){
          var t = arrays[i],
          careAbout = { // what props we&#x27;re interested in, and what we call them in output, rather than silly exif-ey names
            &#x22;Make&#x22; : &#x22;Make&#x22;,
            &#x22;Model&#x22; : &#x22;Model&#x22;,
            &#x22;DateTimeOriginal&#x22; : &#x22;Time&#x22;,
            &#x22;ApertureValue&#x22; : &#x22;aperture&#x22;,
            &#x22;FocalLength&#x22; : &#x22;focalLength&#x22;,
            &#x22;ISOSpeedRatings&#x22; : &#x22;ISO&#x22;,
            &#x22;ExposureTime&#x22; : &#x22;Shutter Speed&#x22;,
            &#x22;GPSLatitude&#x22; : &#x22;Lat&#x22;,
            &#x22;GPSLongitude&#x22; : &#x22;Long&#x22;,
            &#x22;ImageDescription&#x22; : &#x22;Description&#x22;
          };
          if (careAbout.hasOwnProperty(t.tagName)){
            var key = careAbout[t.tagName],
            value = t.value;

            if (key == &#x22;Shutter Speed&#x22;){
              // Transform shutter speed to a fraction
              value = dec2frac(value);
            }
            if (typeof value==&#x22;number&#x22;){
              value = Math.round(value*100)/100; // no long decimals
            }
            exifMap[key] = value;
          }
        }
        return callback(null, exifMap);
      }
    });
  } catch (error) {
    return callback(error);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-gallery.middleware" id="apidoc.element.node-gallery.middleware">
        function <span class="apidocSignatureSpan">node-gallery.</span>middleware
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">middleware = function (config){
  var app = express(),
  staticFiles = config.staticFiles,
  common = require(&#x27;./common&#x27;)(config),
  album = require(&#x27;./album&#x27;)(config),
  photo = require(&#x27;./photo&#x27;)(config);

  app.set(&#x27;views&#x27;, path.join(__dirname, &#x27;..&#x27;, &#x27;views&#x27;));
  app.set(&#x27;view engine&#x27;, &#x27;ejs&#x27;);


  app.get(&#x27;/gallery.css&#x27;, function(req, res, next){
    var fstream = fs.createReadStream(path.join(__dirname, &#x27;..&#x27;, &#x27;css/gallery.css&#x27;));
    res.type(&#x27;text/css&#x27;);
    fstream.on(&#x27;error&#x27;, function(err){
      return common.error(req, res, next, 404, &#x27;CSS File not found&#x27;, err);
    });
    return fstream.pipe(res);
  });

  // Photo Page
  app.get(/.+(\.(jpg|bmp|jpeg|gif|png|tif)(\?tn=(1|0))?)$/i, function(req, res, next){
    var filePath = path.join(staticFiles, req.path),
    fstream;

    filePath = decodeURI(filePath);

    fs.stat(filePath, function(err){
      if (err){
        return common.error(req, res, next, 404, &#x27;File not found&#x27;, err);
      }
      fstream = fs.createReadStream(filePath);
      fstream.on(&#x27;error&#x27;, function(err){
        return common.error(req, res, next, 404, &#x27;File not found&#x27;, err);
      });

      if (!req.query.tn){
        // return the full size file
        return fstream.pipe(res);
      }else{
        // streaming resize our file
        var cachedResizedKey, cacheWriteStream, cachedResult,
        resizer, dimensions, w, h;
        if (req.query.tn.toString() === &#x27;1&#x27;){
          w = (config.thumbnail &#x26;&#x26; config.thumbnail.width) || 200;
          h = (config.thumbnail &#x26;&#x26; config.thumbnail.height) || 200;
          dimensions = w + &#x27;x&#x27; + h;
        }else {
          w = (config.image &#x26;&#x26; config.image.width) || &#x27;100%&#x27;;
          h = (config.image &#x26;&#x26; config.image.height) || &#x27;100%&#x27;;
          dimensions = w + &#x27;x&#x27; + h;
        }

        cachedResizedKey = filePath + dimensions;
        cachedResizedKey = crypto.createHash(&#x27;md5&#x27;).update(cachedResizedKey).digest(&#x27;hex&#x27;);

        // Check the cache for a previously rezized tn of matching file path and dimensions
        cachedResult = cache.get(cachedResizedKey)
        // TODO - eventualyl should just try the fs.read on cachedResult, existsSync is a bad hack
        if (cachedResult &#x26;&#x26; fs.existsSync(cachedResult)){
          // cache hit - read &#x26; return
          var cacheReadStream = fs.createReadStream(cachedResult);
          cacheReadStream.on(&#x27;error&#x27;, function(){
            return common.error(req, res, next, 404, &#x27;File not found&#x27;, err);
          });
          return cacheReadStream.pipe(res);
        }

        // No result, create a write stream so we don&#x27;t have to reize this image again
        cacheWritePath = path.join(&#x27;/tmp&#x27;, cachedResizedKey);
        cacheWriteStream = fs.createWriteStream(cacheWritePath);



        resizer = im().resize(dimensions).quality(40);
        resizer.on(&#x27;error&#x27;, function(err){
          return common.error(req, res, next, 500, &#x27;Error in IM/GM converting file&#x27;, err);
        });

        var resizestream = fstream.pipe(resizer);

        // Pipe to our tmp cache file, so we can use this in future
        resizestream.pipe(cacheWriteStream);
        cache.put(cachedResizedKey, cacheWritePath);

        // Also stream the resized result back to the requestee
        return resizestream.pipe(res);
      }
    });

  });

  // Photo Pages - anything containing */photo/*
  app.get(/(.+\/)?photo\/(.+)/i, photo, common.render);
  // Album Page - everything that doesn&#x27;t contain the photo string
  // regex source http://stackoverflow.com/questions/406230/regular-expression-to-match-string-not-containing-a-word
  app.get(/^((?!\/photo\/).)*$/, album, common.render);
  return app;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-gallery.photo" id="apidoc.element.node-gallery.photo">
        function <span class="apidocSignatureSpan">node-gallery.</span>photo
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">photo = function (config){
  common = require(&#x27;./common&#x27;)(config);
  return function(req, res, next){
    var albumPath = req.params[0] || &#x27;&#x27;, // This CAN be undefined, if a photo exists at root
    photoName = req.params[1] || &#x27;&#x27;,
    photoBreadcrumbPath = path.join(albumPath, photoName), // Path for breadcrumb mostly
    albumFilesystemPath = &#x27;./&#x27; + path.join(config.staticFiles, albumPath),
    photoFileSystemPath,
    photoWebPath;
    fs.readdir(albumFilesystemPath, function(err, files){
      if (err || _.isEmpty(files)){
        return common.error(req, res, next, 404, &#x27;Photo not found&#x27;, err);
      }
      var file = _.find(files, function(file){
        return file.indexOf(photoName) &#x3e; -1;
      });
      if (!file){
        return common.error(req, res, next, 404, &#x27;Photo not found&#x27;, {});
      }
      // Include the /gallery/ or whatever
      photoWebPath = path.join(config.urlRoot, albumPath, file);
      photoFileSystemPath = path.join(albumFilesystemPath, file);

      exif(photoFileSystemPath, function(exifErr, exifInfo){
        if (exifErr){
          // TODO: At least log these errors
          // don&#x27;t care about exif errors - they are frequent with malformed files
          exifInfo = {};
        }

        req.tpl = &#x27;photo.ejs&#x27;;
        req.data = _.extend(config, {
          name : photoName,
          breadcrumb : common.breadcrumb(common.friendlyPath(photoBreadcrumbPath)),
          src : photoWebPath,
          path : photoBreadcrumbPath,
          exif : exifInfo
        });
        return next();
      });
    });

  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-gallery.toString" id="apidoc.element.node-gallery.toString">
        function <span class="apidocSignatureSpan">node-gallery.</span>toString
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toString = function () {
    return text;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (config.render === false){
  // only return compiled template file
  return fs.readFile(path.join(__dirname, &#x27;..&#x27;, &#x27;views&#x27;, tpl), function(err, tplContents){
    if (err){
      return next(err);
    }
    try{
      req.html = ejs.render(tplContents.<span class="apidocCodeKeywordSpan">toString</span>(), data);
    }catch(err){
      return next(err);
    }
    return next();
  });
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-gallery.album" id="apidoc.module.node-gallery.album">module node-gallery.album</a></h1>


    <h2>
        <a href="#apidoc.element.node-gallery.album.album" id="apidoc.element.node-gallery.album.album">
        function <span class="apidocSignatureSpan">node-gallery.</span>album
        <span class="apidocSignatureSpan">(cfg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">album = function (cfg){
  config = cfg;
  common = require(&#x27;./common&#x27;)(config);
  return function(req, res, next){

    // Retrieve the path, decoding %20s etc, replacing leading &#x26; trailing slash
    var pathFromReq = common.friendlyPath(req.path),
    staticFilesPath = &#x27;./&#x27; + path.join(config.staticFiles, pathFromReq),
    data = _.clone(config);

<span class="apidocCodeCommentSpan">    /*
     Request for an album thumbnail - TODO consider splitting out
     */
</span>    if (req.query &#x26;&#x26; req.query.tn){
      return _thumbnail(staticFilesPath, pathFromReq, function(err, thumb){
        if (err){
          return common.error(req, res, next, 404, &#x27;No thumbnail found for this album&#x27;, err);
        }
        var fstream = fs.createReadStream(path.join(thumb));
        fstream.on(&#x27;error&#x27;, function(err){
          return common.error(req, res, next, 404, &#x27;No thumbnail found for this album&#x27;, err);
        });
        return fstream.pipe(res);
      });
    }
    /*
      Determined we&#x27;re not requesting the thumbnail file - render the album page
     */
    fs.readdir(staticFilesPath, function (err, files) {
      if (err){
        return common.error(req, res, next, 404, &#x27;No album found&#x27;, err);
      }

      data.isRoot = (req.path === &#x27;/&#x27; || req.path === &#x27;&#x27;);
      data.breadcrumb = common.breadcrumb(pathFromReq),
      data.name = _.last(data.breadcrumb).name || config.title;

      data.albums = _getAlbums(files, staticFilesPath, pathFromReq);
      data.photos = _getPhotos(files, staticFilesPath, pathFromReq);

      req.data = data;
      req.tpl = &#x27;album.ejs&#x27;;
      return next();
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-gallery.common" id="apidoc.module.node-gallery.common">module node-gallery.common</a></h1>


    <h2>
        <a href="#apidoc.element.node-gallery.common.common" id="apidoc.element.node-gallery.common.common">
        function <span class="apidocSignatureSpan">node-gallery.</span>common
        <span class="apidocSignatureSpan">(cfg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">common = function (cfg){
  config = cfg;
  return common;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-gallery.exif" id="apidoc.module.node-gallery.exif">module node-gallery.exif</a></h1>


    <h2>
        <a href="#apidoc.element.node-gallery.exif.exif" id="apidoc.element.node-gallery.exif.exif">
        function <span class="apidocSignatureSpan">node-gallery.</span>exif
        <span class="apidocSignatureSpan">(staticPath, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">exif = function (staticPath, callback){
  try {
    new ExifImage({
      image : staticPath//&#x27;resources/photos/Ireland/West Coast/_MG_4174.jpg&#x27;
    }, function (error, data) {

      if (error){
        return callback(error);
      }else{
        var exifMap = {};
        var image = data.image,
        exif = data.exif,
        gps = data.gps,
        arrays = image.concat(exif, gps);

        for (var i=0; i&#x3c;arrays.length; i++){
          var t = arrays[i],
          careAbout = { // what props we&#x27;re interested in, and what we call them in output, rather than silly exif-ey names
            &#x22;Make&#x22; : &#x22;Make&#x22;,
            &#x22;Model&#x22; : &#x22;Model&#x22;,
            &#x22;DateTimeOriginal&#x22; : &#x22;Time&#x22;,
            &#x22;ApertureValue&#x22; : &#x22;aperture&#x22;,
            &#x22;FocalLength&#x22; : &#x22;focalLength&#x22;,
            &#x22;ISOSpeedRatings&#x22; : &#x22;ISO&#x22;,
            &#x22;ExposureTime&#x22; : &#x22;Shutter Speed&#x22;,
            &#x22;GPSLatitude&#x22; : &#x22;Lat&#x22;,
            &#x22;GPSLongitude&#x22; : &#x22;Long&#x22;,
            &#x22;ImageDescription&#x22; : &#x22;Description&#x22;
          };
          if (careAbout.hasOwnProperty(t.tagName)){
            var key = careAbout[t.tagName],
            value = t.value;

            if (key == &#x22;Shutter Speed&#x22;){
              // Transform shutter speed to a fraction
              value = dec2frac(value);
            }
            if (typeof value==&#x22;number&#x22;){
              value = Math.round(value*100)/100; // no long decimals
            }
            exifMap[key] = value;
          }
        }
        return callback(null, exifMap);
      }
    });
  } catch (error) {
    return callback(error);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-gallery.middleware" id="apidoc.module.node-gallery.middleware">module node-gallery.middleware</a></h1>


    <h2>
        <a href="#apidoc.element.node-gallery.middleware.middleware" id="apidoc.element.node-gallery.middleware.middleware">
        function <span class="apidocSignatureSpan">node-gallery.</span>middleware
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">middleware = function (config){
  var app = express(),
  staticFiles = config.staticFiles,
  common = require(&#x27;./common&#x27;)(config),
  album = require(&#x27;./album&#x27;)(config),
  photo = require(&#x27;./photo&#x27;)(config);

  app.set(&#x27;views&#x27;, path.join(__dirname, &#x27;..&#x27;, &#x27;views&#x27;));
  app.set(&#x27;view engine&#x27;, &#x27;ejs&#x27;);


  app.get(&#x27;/gallery.css&#x27;, function(req, res, next){
    var fstream = fs.createReadStream(path.join(__dirname, &#x27;..&#x27;, &#x27;css/gallery.css&#x27;));
    res.type(&#x27;text/css&#x27;);
    fstream.on(&#x27;error&#x27;, function(err){
      return common.error(req, res, next, 404, &#x27;CSS File not found&#x27;, err);
    });
    return fstream.pipe(res);
  });

  // Photo Page
  app.get(/.+(\.(jpg|bmp|jpeg|gif|png|tif)(\?tn=(1|0))?)$/i, function(req, res, next){
    var filePath = path.join(staticFiles, req.path),
    fstream;

    filePath = decodeURI(filePath);

    fs.stat(filePath, function(err){
      if (err){
        return common.error(req, res, next, 404, &#x27;File not found&#x27;, err);
      }
      fstream = fs.createReadStream(filePath);
      fstream.on(&#x27;error&#x27;, function(err){
        return common.error(req, res, next, 404, &#x27;File not found&#x27;, err);
      });

      if (!req.query.tn){
        // return the full size file
        return fstream.pipe(res);
      }else{
        // streaming resize our file
        var cachedResizedKey, cacheWriteStream, cachedResult,
        resizer, dimensions, w, h;
        if (req.query.tn.toString() === &#x27;1&#x27;){
          w = (config.thumbnail &#x26;&#x26; config.thumbnail.width) || 200;
          h = (config.thumbnail &#x26;&#x26; config.thumbnail.height) || 200;
          dimensions = w + &#x27;x&#x27; + h;
        }else {
          w = (config.image &#x26;&#x26; config.image.width) || &#x27;100%&#x27;;
          h = (config.image &#x26;&#x26; config.image.height) || &#x27;100%&#x27;;
          dimensions = w + &#x27;x&#x27; + h;
        }

        cachedResizedKey = filePath + dimensions;
        cachedResizedKey = crypto.createHash(&#x27;md5&#x27;).update(cachedResizedKey).digest(&#x27;hex&#x27;);

        // Check the cache for a previously rezized tn of matching file path and dimensions
        cachedResult = cache.get(cachedResizedKey)
        // TODO - eventualyl should just try the fs.read on cachedResult, existsSync is a bad hack
        if (cachedResult &#x26;&#x26; fs.existsSync(cachedResult)){
          // cache hit - read &#x26; return
          var cacheReadStream = fs.createReadStream(cachedResult);
          cacheReadStream.on(&#x27;error&#x27;, function(){
            return common.error(req, res, next, 404, &#x27;File not found&#x27;, err);
          });
          return cacheReadStream.pipe(res);
        }

        // No result, create a write stream so we don&#x27;t have to reize this image again
        cacheWritePath = path.join(&#x27;/tmp&#x27;, cachedResizedKey);
        cacheWriteStream = fs.createWriteStream(cacheWritePath);



        resizer = im().resize(dimensions).quality(40);
        resizer.on(&#x27;error&#x27;, function(err){
          return common.error(req, res, next, 500, &#x27;Error in IM/GM converting file&#x27;, err);
        });

        var resizestream = fstream.pipe(resizer);

        // Pipe to our tmp cache file, so we can use this in future
        resizestream.pipe(cacheWriteStream);
        cache.put(cachedResizedKey, cacheWritePath);

        // Also stream the resized result back to the requestee
        return resizestream.pipe(res);
      }
    });

  });

  // Photo Pages - anything containing */photo/*
  app.get(/(.+\/)?photo\/(.+)/i, photo, common.render);
  // Album Page - everything that doesn&#x27;t contain the photo string
  // regex source http://stackoverflow.com/questions/406230/regular-expression-to-match-string-not-containing-a-word
  app.get(/^((?!\/photo\/).)*$/, album, common.render);
  return app;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-gallery.photo" id="apidoc.module.node-gallery.photo">module node-gallery.photo</a></h1>


    <h2>
        <a href="#apidoc.element.node-gallery.photo.photo" id="apidoc.element.node-gallery.photo.photo">
        function <span class="apidocSignatureSpan">node-gallery.</span>photo
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">photo = function (config){
  common = require(&#x27;./common&#x27;)(config);
  return function(req, res, next){
    var albumPath = req.params[0] || &#x27;&#x27;, // This CAN be undefined, if a photo exists at root
    photoName = req.params[1] || &#x27;&#x27;,
    photoBreadcrumbPath = path.join(albumPath, photoName), // Path for breadcrumb mostly
    albumFilesystemPath = &#x27;./&#x27; + path.join(config.staticFiles, albumPath),
    photoFileSystemPath,
    photoWebPath;
    fs.readdir(albumFilesystemPath, function(err, files){
      if (err || _.isEmpty(files)){
        return common.error(req, res, next, 404, &#x27;Photo not found&#x27;, err);
      }
      var file = _.find(files, function(file){
        return file.indexOf(photoName) &#x3e; -1;
      });
      if (!file){
        return common.error(req, res, next, 404, &#x27;Photo not found&#x27;, {});
      }
      // Include the /gallery/ or whatever
      photoWebPath = path.join(config.urlRoot, albumPath, file);
      photoFileSystemPath = path.join(albumFilesystemPath, file);

      exif(photoFileSystemPath, function(exifErr, exifInfo){
        if (exifErr){
          // TODO: At least log these errors
          // don&#x27;t care about exif errors - they are frequent with malformed files
          exifInfo = {};
        }

        req.tpl = &#x27;photo.ejs&#x27;;
        req.data = _.extend(config, {
          name : photoName,
          breadcrumb : common.breadcrumb(common.friendlyPath(photoBreadcrumbPath)),
          src : photoWebPath,
          path : photoBreadcrumbPath,
          exif : exifInfo
        });
        return next();
      });
    });

  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-gallery.toString" id="apidoc.module.node-gallery.toString">module node-gallery.toString</a></h1>


    <h2>
        <a href="#apidoc.element.node-gallery.toString.toString" id="apidoc.element.node-gallery.toString.toString">
        function <span class="apidocSignatureSpan">node-gallery.</span>toString
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function toString() { [native code] }</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (config.render === false){
  // only return compiled template file
  return fs.readFile(path.join(__dirname, &#x27;..&#x27;, &#x27;views&#x27;, tpl), function(err, tplContents){
    if (err){
      return next(err);
    }
    try{
      req.html = ejs.render(tplContents.<span class="apidocCodeKeywordSpan">toString</span>(), data);
    }catch(err){
      return next(err);
    }
    return next();
  });
}
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
